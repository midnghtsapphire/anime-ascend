import React, { createContext, useContext, useState } from 'react';\n\nexport type SubscriptionTier = 'free' | 'premium' | 'pro';\n\nexport interface Subscription {\n  tier: SubscriptionTier;\n  status: 'active' | 'trial' | 'cancelled' | 'past_due';\n  currentPeriodStart: string;\n  currentPeriodEnd: string;\n  cancelAtPeriodEnd: boolean;\n  stripeCustomerId: string;\n  stripeSubscriptionId: string;\n}\n\nexport interface TokenUsage {\n  tokensRemaining: number;\n  tokensUsedThisMonth: number;\n  monthlyAllowance: number;\n  lastResetDate: string;\n}\n\nexport interface BillingInfo {\n  subscription: Subscription;\n  tokenUsage: TokenUsage;\n  paymentMethod?: {\n    brand: string;\n    last4: string;\n    expMonth: number;\n    expYear: number;\n  };\n}\n\ninterface BillingContextType {\n  billing: BillingInfo | null;\n  isLoading: boolean;\n  upgradeToTrial: () => Promise<void>;\n  upgradeToPremium: () => Promise<void>;\n  upgradeToPro: () => Promise<void>;\n  cancelSubscription: () => Promise<void>;\n  updatePaymentMethod: (token: string) => Promise<void>;\n  consumeToken: (amount: number) => Promise<void>;\n  refund: (reason: string) => Promise<void>;\n}\n\nconst BillingContext = createContext<BillingContextType | undefined>(undefined);\n\ninterface BillingProviderProps {\n  children: React.ReactNode;\n}\n\nexport function BillingProvider({ children }: BillingProviderProps) {\n  const [billing, setBilling] = useState<BillingInfo | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n\n  const upgradeToTrial = async () => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/trial-signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n      });\n\n      if (!response.ok) throw new Error('Trial signup failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Trial signup error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const upgradeToPremium = async () => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/upgrade-premium', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n      });\n\n      if (!response.ok) throw new Error('Upgrade failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Upgrade error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const upgradeToPro = async () => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/upgrade-pro', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n      });\n\n      if (!response.ok) throw new Error('Upgrade failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Upgrade error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const cancelSubscription = async () => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/cancel', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n      });\n\n      if (!response.ok) throw new Error('Cancellation failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Cancellation error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const updatePaymentMethod = async (token: string) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/payment-method', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n        body: JSON.stringify({ token }),\n      });\n\n      if (!response.ok) throw new Error('Payment method update failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Payment method error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const consumeToken = async (amount: number) => {\n    try {\n      const response = await fetch('/api/billing/consume-token', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n        body: JSON.stringify({ amount }),\n      });\n\n      if (!response.ok) throw new Error('Token consumption failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Token consumption error:', error);\n      throw error;\n    }\n  };\n\n  const refund = async (reason: string) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/billing/refund', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('auth-token')}`,\n        },\n        body: JSON.stringify({ reason }),\n      });\n\n      if (!response.ok) throw new Error('Refund request failed');\n      const data = await response.json();\n      setBilling(data);\n    } catch (error) {\n      console.error('Refund error:', error);\n      throw error;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <BillingContext.Provider\n      value={{\n        billing,\n        isLoading,\n        upgradeToTrial,\n        upgradeToPremium,\n        upgradeToPro,\n        cancelSubscription,\n        updatePaymentMethod,\n        consumeToken,\n        refund,\n      }}\n    >\n      {children}\n    </BillingContext.Provider>\n  );\n}\n\nexport function useBilling() {\n  const context = useContext(BillingContext);\n  if (!context) {\n    throw new Error('useBilling must be used within BillingProvider');\n  }\n  return context;\n}\n
